<?php 
$url = $this->request->here;
$res_data = explode('/', $url);
//pr($res_data);
$last_delemeter = end($res_data);
$selected_id = $res_data[count($res_data)-2];
//echo $selected_id;
//echo $last_delemeter;
//pr($to_user_details);


?>

<script type="text/javascript">

    
 function send_message_all()
 {
       var user_name= $('#form_username').val();
       var subject= $('#subject').val();
       var message= $('#message').val();
      
     
var url = '<?php echo BASE_URL.'messages/save_message'; ?>';
		$.ajax({
			type: 'POST',
			url: url,
			data: {username:user_name,subject:subject,message:message},
			success:function(result)
			{
				 
				
                        if(result==0)
                        {
                            
                           $('#show_message_usename').show(); 
                           $("#form_username").focus();
                           
                           return false;
                        }
			
			//alert(result);
				right_content_ajax(result,user_name); 
                        
                         $('#show_message_usename').hide(); 
                        
               var url1 = '<?php echo BASE_URL.'messages/ajax_conversation'; ?>';
		$.ajax({
			type: 'POST',
			url: url1,
			data: {username:user_name,user_id:$.trim(result)},
			success:function(result1)
			{
			

$("#message_content" ).fadeIn(3000,function(){
			$("#message_content" ).html(result1);
		});	
			$('#form_username').val("");
			$('#subject').val("");
			$('#message').val("");
				
			}
	}); 
                            
                         
                            
				
			}
	});	
  }
  
  function right_content_ajax(res,user_name)
  {
			/********Send user details*****/
			
			var url2 = '<?php echo BASE_URL.'messages/get_user_details'; ?>';
			$.ajax({
				type: 'POST',
				url: url2,
				data: {username:user_name,user_id:res},
				success:function(result2)
				{
				//alert(result2);
				$("#right_data_ajax").html(result2);
					
				}
			}); 
                            
  }
  
  

</script>



    <section class="emai-registration">
    <div class="topheading-box">
       <div class="container">
             <h2>Message</h2>
       </div>
    </div>
      <div class="container">
      	<div class="msg_container">
            <div class="msg_nav">
                <!--<ul>
                  <li class="inbox"><a href="<?php echo BASE_URL;?>messages/MessageInbox" >Inbox</a></li>
                   <li class="compose_active"><a href="<?php echo BASE_URL;?>messages/conversation/9/Clinicmanager">Compose</a></li>
                    <li class="outbox"><a href="<?php echo BASE_URL;?>messages/MessageOutbox" >Outbox</a></li>
                    <li class="draft"><a href="<?php echo BASE_URL;?>messages/MessageTrash">Trash</a></li>
                </ul>-->
		<?php echo $this->element("frontend/message_tab");?>
               <!-- <div class="all_msg">
                    <select class="custom-select" style="width:220px;">
                        <option value="">All Messages (5)</option>
                        <option value="">test 1</option>
                        <option value="">test 2</option>
                        <option value="">test 3</option>
                    </select>
                </div>-->
            </div>
		<!----Logged user details and Get user message Start----->
	<?php
	
		$logged_user_var = 0;
		$to_user_var = 0;
		
		if(count($all_messages))
		{
			$logged_user_details = array();
		
			$to_user_details = array();
		
		}
		else
		{
			$logged_user_details=$logged_user_details['User'];
			
		}
		
		
		for($i=0;$i<count($all_messages);$i++)
		{
			if($logged_user_var == 1 && $to_user_var == 1)
			{
				break;
			}
			if($all_messages[$i]['User']['id']==$this->Session->read('reid_user_uid') && $all_messages[$i]['User']['user_type']!='superadmin')
			{
				$logged_user_var = 1 ;
				$logged_user_details = $all_messages[$i]['User'];
				//print_r($logged_user_details);
			}
			else
			{
				$to_user_var = 1;
				$to_user_details = $all_messages[$i]['User'];
				//print_r($to_user_details);
			}
			if($all_messages[$i]['ToUser']['id']==$this->Session->read('reid_user_uid') && $all_messages[$i]['ToUser']['user_type']!='superadmin')
			{
				$logged_user_var = 1 ;
				$logged_user_details = $all_messages[$i]['ToUser'];
				//print_r($logged_user_details);
			}
			else
			{
				$to_user_var = 1;
				$to_user_details = $all_messages[$i]['ToUser'];
				//print_r($to_user_details);
			}
			
		}
		
	?>
		<!----Logged user details and Get user message End----->
            <div class="compose_msg">
		<!-----Sender user Details Start----->
		<?php
		if(trim($last_delemeter) == "thismsg")
		{
		?>
            	<div class="col-xs-12 col-sm-12 col-md-4 msg_composer_main">
                	<div class="msg_composer">
					<div class="left">
						
						<?php
						if(($to_user_details['profile_image']!='') && (file_exists("frontend/uploads/profile_image/".$to_user_details['profile_image'])))
						{ 
						?>
							<img src="<?php echo $this->webroot; ?>frontend/uploads/profile_image/thumbimage/<?php echo $to_user_details['profile_image'] ?>">
						<?php
						}
						else
						{
						?>
							<img src="<?php echo $this->webroot; ?>frontend/images/no-avatar.jpg">
						<?php
						}
						?>
					</div>
			
                        <div class="right">
                    		<h2><?php if(isset($to_user_details['username'])) {echo $to_user_details['username'];}?></h2>
				<p><?php if($to_user_details['user_type']==2){echo "Clinic Manager";}
				elseif($to_user_details['user_type']==1){echo "User";}else{echo "Superadmin";}?></p>
                        </div>
			
                    </div>
                </div>
		<?php
		}
		else
		{
		?>
		<div id="right_data_ajax">
			
		</div>
		<?php
		}
		?>
		<!-----Sender user Details End----->
            	<div class="col-xs-12 col-sm-12 col-md-8">
		<!------For Send Message Start----->
                	<div class="msg_list_in">
                    	<div class="left">
							<?php
							if($logged_user_details['profile_image']!='' && (file_exists("frontend/uploads/profile_image/".$logged_user_details['profile_image'])))
							{
							?>
								<img src="<?php echo $this->webroot; ?>frontend/uploads/profile_image/thumbimage/<?php echo $logged_user_details['profile_image'] ?>">
							<?php
							}
							else
							{
							?>
								<img src="<?php echo $this->webroot; ?>frontend/images/no-avatar.jpg">
							<?php
							}
							?>
						</div>
			<h4><?php echo $logged_user_details['username'];?></h4><!----NA---->
                        <div class="middle">
				
                       
			
				<?php echo $this->Form->create('Messagecontent',$settings=array( 'url' => array('controller' => 'messages', 'action' => 'save_message'),'id'=>'comment_form','name'=>'comment_form')); ?>
				
				<!--<input type="hidden"  name="toid" value="<?php echo $to_user_details['id'];?>">
				<input type="hidden"  name="touname" value="<?php echo $to_user_details['username'];?>">-->
				<?php //if($to_user_details['user_type']==2){$usertype="Clinicmanager";}
				//elseif($to_user_details['user_type']==1){$usertype="user";}else{$usertype="superadmin";}?>
				<!--<input type="hidden" name="totype" value="<?php echo $usertype;?>">-->
				
				<!--<input type="hidden"  name="fromid" value="<?php echo $logged_user_details['id'];?>">
				<input type="hidden" name="fromuname" value="<?php echo $logged_user_details['username'];?>">-->
				<?php //if($logged_user_details['user_type']==2){$usertype="Clinicmanager";}
				//elseif($logged_user_details['user_type']==1){$usertype="user";}?>
				<!--<input type="hidden" name="fromtype" value="<?php echo $usertype;?>">-->
                                
                                <p>Please Enter User Name</p>
                                <input type="text" name="form_username" id="form_username" class="subject_text" >
                                
                                <span id="show_message_usename" style="display:none; color: #FF0000">Username is not exist. </span>
<!--                                <input type="text" name="username" id="username" class="typeahead subject_text  tt-input" >-->
                                <div style="clear:both;"></div>
				<p>Subject</p>
                                <input type="text" name="subject" id="subject" class="subject_text">
				<p>Message</p>
                                <textarea rows="5" cols="5" name="message" id="message" class="text_msg"></textarea>
                                <input type="button" name="save" value="Send" class="save btn_send" onclick="return send_message_all()"/>
				
				<?php echo $this->Form->end(); ?>
		
		
                        </div>
                        <!--<div class="days_ago">3 days ago</div>-->
			</div>
                
        
		<!------For Send Message End----->
			
		<!------For Messages Show Start----->
                 <div id='message_content'> 
                     
					 <!------For Messages Show Start----->
<?php
if(trim($last_delemeter) == "thismsg")
{
	if(count($all_messages))
	{
		//pr($all_messages);	
		
		foreach($all_messages as $value)
		{
			
			//pr($value);
		
			if($value['User']['id']==$to_user_details['id'])
			{
				
		?>
			<div class="msg_list_out">
				<div class="right" style='border-radius:0% 0% 0% 0%'><h4><?php echo $to_user_details['username'];?></h4>
					
						
						<?php
						//pr($value);
						if(($value['User']['profile_image']!='') && (file_exists("frontend/uploads/profile_image/".$value['User']['profile_image'])))
						{
						?>
							<img src="<?php echo $this->webroot; ?>frontend/uploads/profile_image/thumbimage/<?php echo $value['User']['profile_image'] ?>">
						<?php
						}
						else
						{
						?>
							<img src="<?php echo $this->webroot; ?>frontend/images/no-avatar.jpg">
						<?php
						}
						?>
					
				</div>
				<div class="middleown"    <?php if($m_id==$value['Message']['id']){ ?>style="box-shadow: 0 0 5px #000;"<?php }?> id="middle_<?php echo $value['Message']['id'];?>"> <!--F3FFE8-->
				<div class="add_msg"><?php //echo $this->Html->image('../frontend/images/icon31.jpg',array('alt'=>'')); ?></div>
				<h4 style='color:tomato;'><?php echo $value['Messagecontent']['subject'];?></h4>
				<p><?php echo $value['Messagecontent']['message'];?></p>
				</div>
				<div class="days_ago">
				<?php $ret_str=($this->Functions->calculate_time_gap(date('Y-m-d H:i:s'),$value['Messagecontent']['datesent']));if($ret_str['Y']!=0||$ret_str['M']!=0){echo "Nearly ";} if($ret_str['Y']!=0){ echo $ret_str['Y'].' Year'; if($ret_str['Y']>1){echo 's';}}if($ret_str['M']!=0){ echo ' '.$ret_str['M'].' Month'; if($ret_str['M']>1){echo 's';}}if($ret_str['d']!=0){ echo ' '.$ret_str['d'].' Day'; if($ret_str['d']>1){echo 's ';}}if($ret_str['h']!=0){ echo ' '.$ret_str['h'].' Hour'; if($ret_str['h']>1){echo 's ';}}if($ret_str['m']!=0){ echo ' '.$ret_str['m'].' Minute'; if($ret_str['m']>1){echo 's ';}}if($ret_str['Y']!=0||$ret_str['M']!=0||$ret_str['d']!=0||$ret_str['h']!=0||$ret_str['m']!=0){echo ' ago ';}else{echo 'Just Now';}?>
				</div>
			</div>
		<?php
			}
			else
			{
			
		?>
			
			<div class="msg_list_in">
				<div class="left" style='border-radius:0% 0% 0% 0%'><h4><?php echo $logged_user_details['username'];?></h4>
				<?php
				if($logged_user_details['profile_image']!='' && (file_exists("frontend/uploads/profile_image/".$logged_user_details['profile_image'])))
				{
				?>
					<img src="<?php echo $this->webroot; ?>frontend/uploads/profile_image/thumbimage/<?php echo $logged_user_details['profile_image'] ?>">
				<?php
				}
				else
				{
				?>
					<img src="<?php echo $this->webroot; ?>frontend/images/no-avatar.jpg">
				<?php
				}
				?>
				</div>
				<div class="middle"  <?php if($m_id==$value['Message']['id']){ ?>style="box-shadow: 0 0 7px #000;"<?php }?>  id="middle_<?php echo $value['Message']['id'];?>">
				<div class="add_msg"><?php //echo $this->Html->image('../frontend/images/icon31.jpg',array('alt'=>'')); ?></div>
				<h4 style='color:tomato;'><?php echo $value['Messagecontent']['subject'];?></h4>
				<p><?php echo $value['Messagecontent']['message'];?></p>
				
				</div>
				<div class="days_ago">
				<?php $ret_str=($this->Functions->calculate_time_gap(date('Y-m-d H:i:s'),$value['Messagecontent']['datesent']));if($ret_str['Y']!=0||$ret_str['M']!=0){echo "Nearly ";} if($ret_str['Y']!=0){ echo $ret_str['Y'].' Year'; if($ret_str['Y']>1){echo 's';}}if($ret_str['M']!=0){ echo ' '.$ret_str['M'].' Month'; if($ret_str['M']>1){echo 's';}}if($ret_str['d']!=0){ echo ' '.$ret_str['d'].' Day'; if($ret_str['d']>1){echo 's ';}}if($ret_str['h']!=0){ echo ' '.$ret_str['h'].' Hour'; if($ret_str['h']>1){echo 's ';}}if($ret_str['m']!=0){ echo ' '.$ret_str['m'].' Minute'; if($ret_str['m']>1){echo 's ';}}if($ret_str['Y']!=0||$ret_str['M']!=0||$ret_str['d']!=0||$ret_str['h']!=0||$ret_str['m']!=0){echo ' ago ';}else{echo 'Just Now';}?>
				</div>
			</div>
			
			
		<?php
			}
		}
	}
}
?>
		
		
                     
                       </div>
		
                </div>
            </div>
        </div>
      </div>
    </section>
    
  
<input type="hidden" name="input_userid" id="input_userid"/>
         
<!--/////////////////////////////////////////////////////////Auto Complete//////////////////////////////////////////////////////////////-->

<!------------------------------Auto Complete------------------------------------------------->

<?php
     echo $this->Html->css('../frontend/css/styles');
     echo $this->Html->script('../frontend/js/typehead.min');
?>

<script>
     
var substringMatcher = function(strs) {
  return function findMatches(q, cb) {
    var matches, substrRegex;
 
    // an array that will be populated with substring matches
    matches = [];
 
    // regex used to determine if a string contains the substring `q`
    substrRegex = new RegExp(q, 'i');
 
    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        // the typeahead jQuery plugin expects suggestions to a
        // JavaScript object, refer to typeahead docs for more info
        matches.push({ value: str });
      }
    });
 
    cb(matches);
  };
};
 
var states = [<?php echo $auto_data;?>];
 //alert(states);
$('.typeahead').typeahead({
  hint: true,
  highlight: true,
  minLength: 1
},
{
  name: 'states',
  displayKey: 'value',
  source: substringMatcher(states)
});
 
</script>



<?php

if(trim($last_delemeter) == "thismsg")
{
?>
	<script>
	$(document).ready(function()
		{
			//alert("hi");
			$('html, body').animate({scrollTop: $("#middle_<?php echo $selected_id;?>").offset().top}, 2000);
                        
                        
                 });  
	</script> 
<?php
}

?>



<script>
   
/*var substringMatcher = function(strs) {
  return function findMatches(q, cb) {
    var matches, substrRegex;
 
    // an array that will be populated with substring matches
    matches = [];
 
    // regex used to determine if a string contains the substring `q`
    substrRegex = new RegExp(q, 'i');
 
    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        // the typeahead jQuery plugin expects suggestions to a
        // JavaScript object, refer to typeahead docs for more info
        matches.push({ value: str });
      }
    });

    cb(matches);
  };
};
 
var all_username = [<?php echo $auto_data;?>];



$('.typeahead').typeahead({



  hint: true,
  highlight: true,
  minLength: 1
},
{
    
    //alert(all_username);
  
  name: 'states',
  displayKey: 'value',
  source: substringMatcher(all_username)
});


         
  */                      
		
</script>





